!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("openlayers"),require("echarts")):"function"==typeof define&&define.amd?define(["openlayers","echarts"],e):(t=t||self).ol3Echarts=e(t.ol,t.echarts)}(this,function(t,r){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r;var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function s(t){var e=typeof t;return null!==t&&("object"==e||"function"==e)}function i(o,i){for(var t=arguments,r=[],e=2;e<arguments.length;e++)r[e-2]=t[e];return function(){for(var t=arguments,e=[],n=0;n<arguments.length;n++)e[n]=t[n];return o.apply(i,r.concat(Array.prototype.slice.call(e)))}}function o(t,e){for(var n,o=0,i=t.length;o<i;o++)if(t[o].seriesIndex===e.seriesIndex){n=o;break}return void 0===n?t.push(e):t[n]=e,t}function a(){return function t(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()}var h=function(e,n){return Object.keys(n).forEach(function(t){s(n[t])&&s(e[t])?h(e[t],n[t]):e[t]=n[t]}),e};function p(t,e){t.forEach(function(t){e[t]&&(e[t]=e[t].bind(e))})}function c(t){return t&&t.parentNode?t.parentNode.removeChild(t):null}function e(t,e){var n=new MouseEvent(t,{button:e.pointerEvent.button,buttons:e.pointerEvent.buttons,clientX:e.pointerEvent.clientX,clientY:e.pointerEvent.clientY,zrX:e.pointerEvent.offsetX,zrY:e.pointerEvent.offsetY,movementX:e.pointerEvent.movementX,movementY:e.pointerEvent.movementY,relatedTarget:e.pointerEvent.relatedTarget,screenX:e.pointerEvent.screenX,screenY:e.pointerEvent.screenY,view:window});return n.zrX=e.pointerEvent.offsetX,n.zrY=e.pointerEvent.offsetY,n.event=n}function d(t,e,n){for(var o=[],i=[e[0],e[1]],r=i[0],s=i[1],a=0;a<t.length;a+=2){var h=t.charCodeAt(a)-64,p=t.charCodeAt(a+1)-64;h=h>>1^-(1&h),p=p>>1^-(1&p),r=h+=r,s=p+=s,o.push([h/n,p/n])}return o}function u(t){var e=function(t){if(!t.UTF8Encoding)return t;var e=t.UTF8Scale;null==e&&(e=1024);for(var n=t.features,o=0;o<n.length;o++)for(var i=n[o].geometry,r=[i.coordinates,i.encodeOffsets],s=r[0],a=r[1],h=0;h<s.length;h++){var p=s[h];if("Polygon"===i.type)s[h]=d(p,a[h],e);else if("MultiPolygon"===i.type)for(var c=0;c<p.length;c++){var u=p[c];p[c]=d(u,a[h][c],e)}}return t.UTF8Encoding=!1,t}(t);return{type:"FeatureCollection",crs:{},features:r.util.map(r.util.filter(e.features,function(t){return t.geometry&&t.properties&&0<t.geometry.coordinates.length}),function(t){var e=t.properties,n=t.geometry,o=n.coordinates,i=[];return"Polygon"===n.type&&i.push(o[0]),"MultiPolygon"===n.type&&r.util.each(o,function(t){t[0]&&i.push(t[0])}),{properties:e,type:"Feature",geometry:{type:"Polygon",coordinates:i}}})}}var l=Object.freeze({__proto__:null,pie:function(t,e,n){return e.center=n.dataToPoint(e.coordinates),e},bar:function(o,t,i){return s(o.grid)&&!Array.isArray(o.grid)?console.log(o):Array.isArray(o.grid)&&(o.grid=o.grid.map(function(t,e){var n=i.dataToPoint(o.series[e].coordinates);return t.left=n[0]-parseFloat(t.width)/2,t.top=n[1]-parseFloat(t.height)/2,t})),t},line:function(o,t,i){return s(o.grid)&&!Array.isArray(o.grid)?console.log(o):Array.isArray(o.grid)&&(o.grid=o.grid.map(function(t,e){var n=i.dataToPoint(o.series[e].coordinates);return t.left=n[0]-parseFloat(t.width)/2,t.top=n[1]-parseFloat(t.height)/2,t})),t}}),f=t.Map,y=t.Object,g=t.proj.transform;f.prototype.getOverlayContainer||(f.prototype.getOverlayContainer=function(t){t=t||"ol-overlaycontainer";var e=this.getViewport();if(e){var n=e.getElementsByClassName(t);return n&&0<n.length?n[0]:null}return null}),f.prototype.getOverlayContainerStopEvent||(f.prototype.getOverlayContainerStopEvent=function(t){t=t||"ol-overlaycontainer-stopevent";var e=this.getViewport();if(e){var n=e.getElementsByClassName(t);return n&&0<n.length?n[0]:null}return null});var v,m,w,E={forcedRerender:!1,forcedPrecomposeRerender:!1,hideOnZooming:!1,hideOnMoving:!1,hideOnRotating:!1,convertTypes:["pie","line","bar"],insertFirst:!1,stopEvent:!1,polyfillEvents:!1};function _(){this.constructor=m}function $(t,e,n){var o=this,i=Object.assign(E,e);return(o=v.call(this,i)||this)._options=i,o._chartOptions=t,o.$chart=null,o.$container=void 0,o._isRegistered=!1,o._initEvent=!1,o._incremental=[],o._coordinateSystem=null,o.coordinateSystemId="",p(["redraw","onResize","onZoomEnd","onCenterChange","onDragRotateEnd","onMoveStart","onMoveEnd","mouseDown","mouseUp","onClick"],o),n&&o.setMap(n),o}return n(m=$,w=v=y),m.prototype=null===w?Object.create(w):(_.prototype=w.prototype,new _),$.prototype.appendTo=function(t){this.setMap(t)},$.prototype.getMap=function(){return this._map},$.prototype.setMap=function(t){var e=this;if(!(t&&t instanceof f))throw new Error("not ol map object");this._map=t,this._map.once("postrender",function(){e.handleMapChanged()}),this._map.renderSync()},$.prototype.getChartOptions=function(){return this._chartOptions},$.prototype.setChartOptions=function(t){return void 0===t&&(t={}),this._chartOptions=t,this.clearAndRedraw(),this},$.prototype.appendData=function(t,e){return void 0===e&&(e=!0),t&&(e&&(this._incremental=o(this._incremental,{data:t.data,seriesIndex:t.seriesIndex})),this.$chart.appendData({data:t.data.copyWithin(),seriesIndex:t.seriesIndex})),this},$.prototype.clear=function(){this._incremental=[],this.$chart&&this.$chart.clear()},$.prototype.remove=function(){this.clear(),this.$chart&&this.$chart.dispose(),this._initEvent&&this.$container&&(this.$container&&c(this.$container),this.unBindEvent()),delete this.$chart,delete this._map},$.prototype.show=function(){this.setVisible(!0)},$.prototype.hide=function(){this.setVisible(!1)},$.prototype.isVisible=function(){return this.$container&&"none"!==this.$container.style.display},$.prototype.showLoading=function(){this.$chart&&this.$chart.showLoading()},$.prototype.hideLoading=function(){this.$chart&&this.$chart.hideLoading()},$.prototype.setZIndex=function(t){this.$container&&("number"==typeof t&&(t=String(t)),this.$container.style.zIndex=t)},$.prototype.getZIndex=function(){return this.$container&&this.$container.style.zIndex},$.prototype.setVisible=function(t){if(t)this.$container&&(this.$container.style.display=""),(e=this.get("options"))&&(this.setChartOptions(e),this.unset("options"));else{this.$container&&(this.$container.style.display="none");var e=this.getChartOptions();this.set("options",e),this.clear(),this.setChartOptions({})}},$.prototype.render=function(){!this.$chart&&this.$container?(this.$chart=r.init(this.$container),this._chartOptions&&(this.registerMap(),this.$chart.setOption(this.convertData(this._chartOptions),!1)),this.dispatchEvent({type:"load",source:this,value:this.$chart})):this.isVisible()&&this.redraw()},$.prototype.redraw=function(){this.clearAndRedraw()},$.prototype.updateViewSize=function(t){this.$container&&(this.$container.style.width=t[0]+"px",this.$container.style.height=t[1]+"px",this.$container.setAttribute("width",String(t[0])),this.$container.setAttribute("height",String(t[1])))},$.prototype.onResize=function(t){var e=this.getMap();if(e){var n=e.getSize();this.updateViewSize(n),this.clearAndRedraw(),t&&this.dispatchEvent({type:"change:size",source:this,value:n})}},$.prototype.onZoomEnd=function(){this._options.hideOnZooming&&this.show();var t=this.getMap();t&&t.getView()&&(this.clearAndRedraw(),this.dispatchEvent({type:"zoomend",source:this,value:t.getView().getZoom()}))},$.prototype.onDragRotateEnd=function(){this._options.hideOnRotating&&this.show();var t=this.getMap();t&&t.getView()&&(this.clearAndRedraw(),this.dispatchEvent({type:"change:rotation",source:this,value:t.getView().getRotation()}))},$.prototype.onMoveStart=function(){this._options.hideOnMoving&&this.hide();var t=this.getMap();t&&t.getView()&&this.dispatchEvent({type:"movestart",source:this,value:t.getView().getCenter()})},$.prototype.onMoveEnd=function(){this._options.hideOnMoving&&this.show();var t=this.getMap();t&&t.getView()&&(this.clearAndRedraw(),this.dispatchEvent({type:"moveend",source:this,value:t.getView().getCenter()}))},$.prototype.onClick=function(t){this.$container&&this.$container.dispatchEvent(e("click",t))},$.prototype.mouseDown=function(t){this.$container&&this.$container.dispatchEvent(e("mousedown",t))},$.prototype.mouseUp=function(t){this.$container&&this.$container.dispatchEvent(e("mouseup",t))},$.prototype.onCenterChange=function(){var t=this.getMap();t&&t.getView()&&(this.clearAndRedraw(),this.dispatchEvent({type:"change:center",source:this,value:t.getView().getCenter()}))},$.prototype.handleMapChanged=function(){var t=this.getMap();if(this._initEvent&&this.$container&&(this.$container&&c(this.$container),this.unBindEvent()),this.$container||(this.createLayerContainer(),this.onResize(!1)),t){var e=this._options.stopEvent?t.getOverlayContainerStopEvent():t.getOverlayContainer();this._options.insertFirst?e.insertBefore(this.$container,e.childNodes[0]||null):e.appendChild(this.$container),this.render(),this.bindEvent(t)}},$.prototype.createLayerContainer=function(){this.$container=document.createElement("div"),this.$container.style.position="absolute",this.$container.style.top="0px",this.$container.style.left="0px",this.$container.style.right="0px",this.$container.style.bottom="0px"},$.prototype.bindEvent=function(t){var e=t.getView();this._options.forcedPrecomposeRerender&&t.on("precompose",this.redraw),t.on("change:size",this.onResize),e.on("change:resolution",this.onZoomEnd),e.on("change:center",this.onCenterChange),e.on("change:rotation",this.onDragRotateEnd),t.on("movestart",this.onMoveStart),t.on("moveend",this.onMoveEnd),this._options.polyfillEvents&&(t.on("pointerdown",this.mouseDown),t.on("pointerup",this.mouseUp),t.on("click",this.onClick)),this._initEvent=!0},$.prototype.unBindEvent=function(){var t=this.getMap();if(t){var e=t.getView();e&&(t.un("precompose",this.redraw),t.un("change:size",this.onResize),e.un("change:resolution",this.onZoomEnd),e.un("change:center",this.onCenterChange),e.un("change:rotation",this.onDragRotateEnd),t.un("movestart",this.onMoveStart),t.un("moveend",this.onMoveEnd),this._options.polyfillEvents&&(t.un("pointerdown",this.mouseDown),t.un("pointerup",this.mouseUp),t.un("click",this.onClick)),this._initEvent=!1)}},$.prototype.clearAndRedraw=function(){if(this.$chart&&this.isVisible()){if(this._options.forcedRerender&&this.$chart.clear(),this.$chart.resize(),this._chartOptions&&(this.registerMap(),this.$chart.setOption(this.convertData(this._chartOptions),!1),this._incremental&&0<this._incremental.length))for(var t=0;t<this._incremental.length;t++)this.appendData(this._incremental[t],!1);this.dispatchEvent({type:"redraw",source:this})}},$.prototype.registerMap=function(){if(this._isRegistered||(this.coordinateSystemId="openlayers_"+a(),r.registerCoordinateSystem(this.coordinateSystemId,this.getCoordinateSystem(this._options)),this._isRegistered=!0),this._chartOptions){var t=this._chartOptions.series;if(t&&s(t)){var e=this._options.convertTypes;if(e)for(var n=t.length-1;0<=n;n--)-1<e.indexOf(t[n].type)||(t[n].coordinateSystem=this.coordinateSystemId),t[n].animation=!1}}},$.prototype.convertData=function(t){var e=t.series;if(e&&0<e.length){if(!this._coordinateSystem){var n=this.getCoordinateSystem(this._options);this._coordinateSystem=new n(this.getMap())}if(e&&s(e)){var o=this._options.convertTypes;if(o)for(var i=e.length-1;0<=i;i--)-1<o.indexOf(e[i].type)&&e[i]&&e[i].hasOwnProperty("coordinates")&&(e[i]=l[e[i].type](t,e[i],this._coordinateSystem))}}return t},$.prototype.getCoordinateSystem=function(s){var e=this.getMap(),n=this.coordinateSystemId,o=function(t){this.map=t,this._mapOffset=[0,0],this.dimensions=["lng","lat"],this.projCode=o.getProjectionCode(this.map)};return o.dimensions=o.prototype.dimensions||["lng","lat"],o.prototype.getZoom=function(){return this.map.getView().getZoom()},o.prototype.setZoom=function(t){return this.map.getView().setZoom(t)},o.prototype.getViewRectAfterRoam=function(){return this.getViewRect().clone()},o.prototype.setMapOffset=function(t){this._mapOffset=t},o.prototype.dataToPoint=function(t){var e;if(t&&Array.isArray(t)&&0<t.length){e=t.map(function(t){return"string"==typeof t?Number(t):t});var n=s&&s.source||"EPSG:4326",o=s&&s.destination||this.projCode,i=this.map.getPixelFromCoordinate(g(e,n,o)),r=this._mapOffset;return[i[0]-r[0],i[1]-r[1]]}return[0,0]},o.prototype.pointToData=function(t){var e=this._mapOffset;return this.map.getCoordinateFromPixel([t[0]+e[0],t[1]+e[1]])},o.prototype.getViewRect=function(){var t=this.map.getSize();return new r.graphic.BoundingRect(0,0,t[0],t[1])},o.prototype.getRoamTransform=function(){return r.matrix.create()},o.prototype.prepareCustoms=function(){var t=this.getViewRect();return{coordSys:{type:n,x:t.x,y:t.y,width:t.width,height:t.height},api:{coord:i(this.dataToPoint,this),size:i(o.dataToCoordsSize,this)}}},o.create=function(t){t.eachSeries(function(t){t.get("coordinateSystem")===n&&(t.coordinateSystem=new o(e))})},o.getProjectionCode=function(t){return t?t.getView()&&t.getView().getProjection().getCode():"EPSG:3857"},o.dataToCoordsSize=function(s,a){var h=this;return void 0===a&&(a=[0,0]),[0,1].map(function(t){var e=a[t],n=[],o=[],i=s[t]/2;n[t]=e-i,o[t]=e+i,n[1-t]=a[1-t],o[1-t]=a[1-t];var r=h.dataToPoint(n)[t]-h.dataToPoint(o)[t];return Math.abs(r)},this)},o},$.prototype.dispatchEvent=function(t){return v.prototype.dispatchEvent.call(this,t)},$.prototype.set=function(t,e,n){return v.prototype.set.call(this,t,e,n)},$.prototype.get=function(t){return v.prototype.get.call(this,t)},$.prototype.unset=function(t,e){return v.prototype.unset.call(this,t,e)},$.prototype.on=function(t,e,n){return v.prototype.on.call(this,t,e,n)},$.prototype.un=function(t,e,n){return v.prototype.un.call(this,t,e,n)},$.formatGeoJSON=u,$.bind=i,$.merge=h,$.uuid=a,$.bindAll=p,$.arrayAdd=o,$.removeNode=c,$.isObject=s,$});